<html>

<head>
    <title>CW Vote</title>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script src="//code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="http://wulph.com/cw-vote/cw-votejs"></script>
    <script>
    
    var locked = false;
        google.load('visualization', '1.0', {'packages':['corechart']});
        google.setOnLoadCallback(function() {
            $(function() {
                onLoad();
            });
        });

    /*
    $(document).ready(function() {

    });
    */

    function onLoad()
    {
        $.when(
            $.ajax({
                url: "http://wulph.com/cw-vote/cw-service.php",
                data: {
                    action: "get_current_poll",
                },
                type: "GET",
                dataType: "json",
                error: error_func
            }),
            $.ajax({
                url: "http://wulph.com/cw-vote/cw-service.php",
                data: {
                    action: "get_vote_current",
                    username: $("#username").val()
                },
                type: "GET",
                dataType: "json",
                error: error_func
            })/*,
            $.ajax({
                url: "http://www.enjin.com/api/v1/api.php",
                data: {
                    method: "User.get",
                },
                type: "POST",
                dataType: "json",
                error: error_func
            })*/
        ).then(drawVoteView);

        results();
        $("#debug").html("Test2");
    }

    //function drawVoteView(poll_response, vote_response, user_response)
    function drawVoteView(poll_response, vote_response)
    {
        var poll = poll_response[0];
        var vote = vote_response[0];
        //$("#debug").append(JSON.stringify(user_response));


        $("#main").append("<h2>" + poll.description + "</h2>\n");
        $("#main").append("<h3>Start: " + poll.start_date + "</h3>\n");
        $("#main").append("<h3>End: " + poll.end_date + "</h3>\n");
        $("#main").append("<input type=\"text\" name=\"username\" id=\"username\" value=\"test\"></input><br>\n");

        $("#main").append("<ul id=\"vote_list\"></ul>\n");
        for(i = 0; i < poll.options.length; i++) {
            if((vote != null) && (vote.option.id == poll.options[i].id)) {
                $("#vote_list").append("<li class=\"selected\" id=\"option-" + poll.options[i].id + "\">" + poll.options[i].name + "</li>\n");
            }
            else {
                $("#vote_list").append("<li id=\"option-" + poll.options[i].id + "\">" + poll.options[i].name + "</li>\n");
            }
        }

        $("#main").append("</ul>\n");

        $("#main").append("<p><button id=\"vote_button\" onclick=\"cast_vote()\">Cast Vote</button></p>\n");
        if(vote != null) {
            $("#main").append("<div id=\"message\"><p>You have already voted in this poll. Click below to recast your vote.</p>"
                + "<button id=\"revote_button\" onclick=\"revote()\">Re-vote</button></div>\n");
                lock_vote();
        }
        else {
            $("#main").append("<div id=\"message\"></div>\n");
        }
        set_click_trigger();
        
    }

    function results()
    {
        // Request results data
        $.ajax({
            url: "http://wulph.com/cw-vote/cw-service.php",
            data: {
                action: "get_current_results",
            },
            type: "GET",
            dataType: "json",
            success: drawResults,
            error: error_func
        });

    }
    function drawResults(response)
    {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Faction');
        data.addColumn('number', 'Votes');

        for(var key in response) {
            data.addRow([key, response[key]]);
        }

        var options = {
            'title':'Poll Results',
            'width' : 800,
            'height': 500
        };
        var chart = new google.visualization.ColumnChart(document.getElementById('results'));
        chart.draw(data, options);
    }

    function revote()
    {
        $("#message").html("");
        unlock_vote();
    }

    function lock_vote()
    {
        //$("#debug").html("lock");
        $("#vote_button").prop("disabled", true);
        locked = true;
    }
    function unlock_vote()
    {
        $("#debug").html("unlock");
        $("#vote_button").prop("disabled", false);
        locked = false;
    }

    function cast_vote()
    {
        var option = $(".selected").html();
        lock_vote();
        $("#debug").html("cast vote: " + option);


        $.ajax({
            url: "http://wulph.com/cw-vote/cw-service.php",
            data: {
                action: "cast_vote",
                username: $("#username").val(),
                option: option
            },
            type: "POST",
            dataType: "text",
            success: function(response) {
                $("#debug").append("<br>" + response);
                $("#message").html("");
                $("#message").append("<p>Your vote for " + option + " was submitted.</p>");
                $("#message").append("<p>Click below to recast your vote.</p>"
                    + "<button id=\"revote_button\" onclick=\"revote()\">Re-vote</button></div>\n");
                results();

            },
            error: error_func
        });
    }

    function set_click_trigger() 
    {
        $("li").click(function() {
            if(locked) { return; }
            if($(this).hasClass("selected")) {
                $("li").removeClass("selected");
                 
            }
            else {
                $("li").removeClass("selected");
                $(this).addClass("selected");
            }

        });

    }
    function error_func(xhr, status, errorThrown) 
    {
        alert("Problem");
        console.log("Error: " + errorThrown);
        console.log("Status: " + status);
        console.dir(xhr);
    }


    </script>
    
    <style>
        .selected {
            background-color: #3333FF;  
        }
        .selected:hover {
            background-color: #3333FF;
        }
        li {
            background-color: #CCCCCC;  
            width: 150px;
            text-align: left;
            margin: 2px 2px 2px 2px;
            padding: 2px 2px 2px 2px;
            /*float: left;*/
        }
        li:hover {
            background-color: #FF6666;
        }
        ul#vote_list {
            display: inline-block;
            padding: 0;
            list-style-type: none;
            
        }
        div#main {
            background-color: #EEEEEE;
            font-weight: bold;
            /*font-size: 40px; */
            text-align: center;
            width: 500px;
            margin-right: auto;
            margin-left: auto;
            padding: 5px 5px 5px 5px;
        }
        div#results {
            text-align: center;
            width: 800px;
            margin-right: auto;
            margin-left: auto;
        }
    </style>

</head>

<body>
    <div class="blah" id="main">
    </div>
    <div class="blah" id="results">
    </div>
    <div class="blah" id="debug">
    </div>
    <p>Test</p>

</body>
</html>
